# This workflow will install Python dependencies, run tests and lint with a variety of Python versions
# For more information see: https://help.github.com/actions/language-and-framework-guides/using-python-with-github-actions

name: Diff review for markup

on:
  pull_request:
    branches: [ main ]

jobs:

  # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # #

  download_repos:

    runs-on: ubuntu-latest

    steps:

      - name: Checkout CredData
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.head.sha }}

      - name: Cache tmp
        id: cache-tmp
        uses: actions/cache@v4
        with:
          path: tmp
          key: cred-data-${{ hashFiles('snapshot.yaml') }}

      - name: Set up Python 3.8
        uses: actions/setup-python@v4
        with:
          python-version: "3.8"

      - name: Produce review report from HEAD
        run: |
          python -m pip install --upgrade pip
          python -m pip install --requirement requirements.txt
          # skip extra hints from git
          git config --global init.defaultBranch work
          python download_data.py --data_dir data
          python review_data.py &>review_head.txt

      - name: Upload artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: review_head
          path: review_head.txt

  # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # #

  review_base:

    needs: [ download_repos ]

    runs-on: ubuntu-latest

    steps:

      - name: Checkout CredData
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.base.sha }}

      - name: Cache tmp
        id: cache-tmp
        uses: actions/cache@v4
        with:
          path: tmp
          key: cred-data-${{ hashFiles('snapshot.yaml') }}

      - name: Set up Python 3.8
        uses: actions/setup-python@v4
        with:
          python-version: "3.8"

      - name: Produce review report from HEAD
        run: |
          python -m pip install --upgrade pip
          python -m pip install --requirement requirements.txt
          python download_data.py --data_dir data
          python review_data.py &>review_base.txt

      - name: Upload artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: review_base
          path: review_base.txt

  # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # #

  diff_review:

    needs: [ download_repos, review_base ]

    runs-on: ubuntu-latest

    steps:

      - name: Download all workflow run artifacts
        uses: actions/download-artifact@v4

      - name: Get diff for review
        run: |
          if diff --color=always review_base/review_base.txt review_head/review_head.txt &>review_diff.txt; then
            # avoid failure in diff
            echo "No difference was found"
          fi

      - name: Upload artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: review_diff
          path: review_diff.txt

  # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # #
